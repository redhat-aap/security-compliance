---
- name: Install and Configure Splunk
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    - block:
        - name: Ensure Python3, pip, and boto libraries are installed
          block:
            - name: Install Python3 and pip
              package:
                name:
                  - python3
                  - python3-pip
                state: present
        
            - name: Install boto3 and botocore using pip
              pip:
                name:
                  - boto3
                  - botocore
                executable: pip3

    - name: Check if Splunk Universal Forwarder is already installed
      stat:
        path: /opt/splunkforwarder
      register: splunk_path

    - block:   
        - name: Debug message if Splunk already exists
          debug:
            msg: "Splunk UF is already installed, skipping installation."
          when: splunk_path.stat.exists
        
        - name: Check if Splunk service exists
          shell: systemctl list-unit-files | grep -w SplunkForwarder.service || true
          register: splunk_service
          changed_when: false
    
        - name: Enable and start Splunk service if it exists
          systemd:
            name: SplunkForwarder
            enabled: yes
            state: started
          when: splunk_service.stdout != ""
    
        - name: Set package filename for aarch64
          set_fact:
            package_file: "splunk-installer-linux-uf-aarch64.tar.gz"
          when:
          - ansible_architecture == "aarch64" 
    
        - name: Set package filename for x86_64
          set_fact:
            package_file: "splunk-installer-linux-uf-x86_64.tar.gz"
          when:
          - ansible_architecture == "x86_64"
    
        - name: Check if Splunk file already exists
          stat:
            path: /tmp/"{{ splunk_url }}"
          register: rpm_stat
        
        - name: Download splunk agent from S3
          amazon.aws.s3_object:
            bucket: "security-tools-storage"
            object: "splunk-installer-linux-uf-x86_64-9.3.5r1.tar.gz"
            dest: "/tmp/SplunkForwarder.tar.gz"
            mode: get
            region: "us-east-1"
          when: not rpm_stat.stat.exists
          register: s3_download
    
        - name: Extract splunk installation files
          unarchive:
            src: /tmp/SplunkForwarder.tar.gz
            dest: /tmp/
            remote_src: yes
            mode: 0700
            owner: root
            group: root
    
        - name: Find extracted Splunk directory
          find:
            paths: /tmp
            patterns: "splunk*"
            file_type: directory
            depth: 2
          register: extracted_dirs

        - name: Set the working directory if extraction found something
          set_fact:
            splunk_dir: "{{ extracted_dirs.files[0].path }}"
          when: extracted_dirs.files | length > 0

        - name: Fail if Splunk directory was not found
          fail:
            msg: "No Splunk directory found after extraction â€” check the archive contents or extraction path."
          when: extracted_dirs.files | length == 0
    
        - name: Ensure the Splunk installer script has executable permission
          file:
            path: "{{ splunk_dir }}/splunk_nix_install.sh"
            mode: '0755'
            state: file
            
        - name: Execute the activation script
          shell: ./splunk_nix_install.sh
          args:
            chdir: "{{ splunk_dir }}"
          register: script_output
    
        - name: Display script output
          debug:
            var: script_output.stdout
    
      when: not splunk_path.stat.exists
